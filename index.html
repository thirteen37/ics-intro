<!--[if lt IE 7]> <html class='no-js ie6' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if IE 7]> <html class='no-js ie7' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if IE 8]> <html class='no-js ie8' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if gt IE 8]><!--> <html  lang='en' xmlns='http://www.w3.org/1999/xhtml'> <!--<![endif]-->
<head>
<title>How not to Build Pyramids with Ice</title>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
<meta name='generator' content='Org-mode'/>
<meta name='author' content='Lim Yu-Xi'/>

<link rel='stylesheet' href='deck.js/core/deck.core.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/goto/deck.goto.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/hash/deck.hash.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/menu/deck.menu.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/navigation/deck.navigation.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/scale/deck.scale.css' type='text/css' />
<link rel='stylesheet' href='deck.js/extensions/status/deck.status.css' type='text/css' />
<link rel='stylesheet' href='deck.js/themes/style/swiss.css' type='text/css' />
<link rel='stylesheet' href='deck.js/themes/transition/fade.css' type='text/css' />
<script src='deck.js/jquery-1.7.2.min.js' type='text/javascript'></script>
<script src='deck.js/core/deck.core.js' type='text/javascript'></script>
<script src='deck.js/modernizr.custom.js' type='text/javascript'></script>
<script src='deck.js/extensions/goto/deck.goto.js' type='text/javascript'></script>
<script src='deck.js/extensions/hash/deck.hash.js' type='text/javascript'></script>
<script src='deck.js/extensions/menu/deck.menu.js' type='text/javascript'></script>
<script src='deck.js/extensions/navigation/deck.navigation.js' type='text/javascript'></script>
<script src='deck.js/extensions/scale/deck.scale.js' type='text/javascript'></script>
<script src='deck.js/extensions/status/deck.status.js' type='text/javascript'></script>
<script type="text/javascript" src="MathJax/MathJax.js">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
            config: ["MMLorHTML.js"], jax: ["input/TeX"],
        //  jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>

<script type='text/javascript'>
  $(document).ready(function () { $.deck('.slide'); });
</script>

<style type='text/css'>
#table-of-contents a {color: inherit;}
#table-of-contents ul {margin-bottom: 0;}
#table-of-contents li {padding: 0;}

#preamble, #postamble {left: 5px; width: 100%;}
#preamble {position: absolute; top: 10px;}
#postamble {}

#title-slide h1 {
    position: static; padding: 0;
    margin-top: 10%;
    -webkit-transform: none;
    -moz-transform: none;
    -ms-transform: none;
    -o-transform: none;
    transform: none;
}
#title-slide h2 {
    text-align: center;
    border:none;
    padding: 0;
    margin: 0;
}
</style>
</head>
<body>
<div id='content' class='deck-container'>

<div id='title-slide' class='slide'>
<h1>How not to Build Pyramids with Ice</h1>  <h2></h2>
</div>


<div id="outline-container-sec-1" class="outline-2  slide">
<h2 id="sec-1">Block of ice sitting on a table</h2>
<div class="outline-text-2" id="text-1">
<p>
How far out can you put it?
</p>


<div class="figure">
<p><img src="./images/block-0.svg"  alt="block-0.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2  slide">
<h2 id="sec-2">Depends on the center-of-gravity</h2>
<div class="outline-text-2" id="text-2">

<div class="figure">
<p><img src="./images/block-1.svg"  alt="block-1.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2  slide">
<h2 id="sec-3">How about another identical ice block?</h2>
<div class="outline-text-2" id="text-3">

<div class="figure">
<p><img src="./images/block-2x.svg"  alt="block-2x.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2  slide">
<h2 id="sec-4">Need to move first block</h2>
<div class="outline-text-2" id="text-4">

<div class="figure">
<p><img src="./images/block-2.svg"  alt="block-2.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2  slide">
<h2 id="sec-5">And a third?</h2>
<div class="outline-text-2" id="text-5">

<div class="figure">
<p><img src="./images/block-3.svg"  alt="block-3.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2  slide">
<h2 id="sec-6">Harmonic series</h2>
<div class="outline-text-2" id="text-6">
\begin{equation}
x_n = \frac{1}{2} \sum\limits_{i=1}^n \frac{1}{i}
\end{equation}
</div>
</div>

<div id="outline-container-sec-7" class="outline-2  slide">
<h2 id="sec-7">After 5 blocks</h2>
<div class="outline-text-2" id="text-7">

<div class="figure">
<p><img src="./images/block-5.svg"  alt="block-5.svg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2  slide">
<h2 id="sec-8">Asynchronous Javascript</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">Single-threaded</h3>
<div class="outline-text-3" id="text-8-1">
<p>
One thing at a time
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">Use callbacks</h3>
<div class="outline-text-3" id="text-8-2">
<p>
So you can do other work instead of just waiting
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2  slide">
<h2 id="sec-9">It&rsquo;s hell</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-javascript">MongoClient.connect(<span style="color: #2aa198;">'mongodb://127.0.0.1:27017/test'</span>, <span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">db</span>) {
  <span style="color: #859900; font-weight: bold;">if</span>(err) <span style="color: #859900; font-weight: bold;">throw</span> err;
  db.dropDatabase(<span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">done</span>) {
    db.createCollection(<span style="color: #2aa198;">'test_custom_key'</span>, <span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">collection</span>) {
      collection.insert({<span style="color: #2aa198;">'a'</span>:1}, <span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">docs</span>) {
        collection.find({<span style="color: #2aa198;">'_id'</span>:<span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ObjectID</span>(<span style="color: #2aa198;">"aaaaaaaaaaaa"</span>)}).toArray(<span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">items</span>) {
          console.dir(items);
          db.close();
        });
      });
    });
  });
});
</pre>
</div>
<p>
<a href="https://github.com/mongodb/node-mongodb-native/blob/master/Readme.md">MongoDB Node driver README</a>
</p>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2  slide">
<h2 id="sec-10">Squint and look at it sideways</h2>
<div class="outline-text-2" id="text-10">

<div class="figure">
<p><img src="./images/pyramid.jpg"  alt="pyramid.jpg"/></p>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2  slide">
<h2 id="sec-11">Some possible solutions</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li>Use named callbacks
</li>
<li>Async.js, Q, etc (<a href="https://github.com/joyent/node/wiki/modules#libraries">Node&rsquo;s wiki</a>)
</li>
<li>ECMAScript 6 (When?)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2  slide">
<h2 id="sec-12">CoffeeScript</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1">Ruby and Python inspired syntax</h3>
</div>
<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2">Compiles quickly to Javascript</h3>
</div>
<div id="outline-container-sec-12-3" class="outline-3">
<h3 id="sec-12-3">Good correspondence between CS and resultant JS</h3>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2  slide">
<h2 id="sec-13">CoffeeScript examples</h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">math</span> =
  <span style="color: #b58900;">root:</span>   Math.sqrt
  <span style="color: #b58900;">square:</span> square
  <span style="color: #b58900;">cube:</span>   (x) <span style="color: #268bd2;">-&gt;</span> x * square x

<span style="color: #268bd2;">race</span> = (winner, runners...) <span style="color: #268bd2;">-&gt;</span>
  print winner, runners

alert <span style="color: #2aa198;">"I knew it!"</span> <span style="color: #859900; font-weight: bold;">if</span> elvis?
</pre>
</div>

<div class="org-src-container">

<pre class="src src-javascript">math = {
  root: Math.sqrt,
  square: square,
  <span style="color: #268bd2;">cube</span>: <span style="color: #859900; font-weight: bold;">function</span>(<span style="color: #268bd2;">x</span>) {
    <span style="color: #859900; font-weight: bold;">return</span> x * square(x);
  }
};

race = <span style="color: #859900; font-weight: bold;">function</span>() {
  <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">runners</span>, <span style="color: #268bd2;">winner</span>;
  winner = <span style="color: #268bd2; font-weight: bold;">arguments</span>[0], runners = 2 &lt;= <span style="color: #268bd2; font-weight: bold;">arguments</span>.length ? __slice.call(<span style="color: #268bd2; font-weight: bold;">arguments</span>, 1) : [];
  <span style="color: #859900; font-weight: bold;">return</span> print(winner, runners);
};

<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">typeof</span> elvis !== <span style="color: #2aa198;">"undefined"</span> &amp;&amp; elvis !== <span style="color: #268bd2; font-weight: bold;">null</span>) {
  alert(<span style="color: #2aa198;">"I knew it!"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2  slide">
<h2 id="sec-14">Iced CoffeeScript</h2>
<div class="outline-text-2" id="text-14">
<p>
<a href="http://maxtaco.github.io/coffee-script/">http://maxtaco.github.io/coffee-script/</a>
</p>
</div>
<div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1">Maxwell Krohn (<a href="https://github.com/maxtaco">@maxtaco</a>)</h3>
<div class="outline-text-3" id="text-14-1">
<p>
Of <a href="http://tamejs.org/">Tamejs</a> and OkCupid and MIT CSAIL
</p>
</div>
</div>

<div id="outline-container-sec-14-2" class="outline-3">
<h3 id="sec-14-2">Fork of CoffeeScript</h3>
</div>
<div id="outline-container-sec-14-3" class="outline-3">
<h3 id="sec-14-3">Drop-in replacement</h3>
<div class="outline-text-3" id="text-14-3">
<p>
Well, nearly. Works except for new keyword conflicts.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-15" class="outline-2  slide">
<h2 id="sec-15">What&rsquo;s new?</h2>
<div class="outline-text-2" id="text-15">
</div><div id="outline-container-sec-15-1" class="outline-3">
<h3 id="sec-15-1"><code>await</code> &#x2026; <code>defer</code></h3>
</div>
</div>

<div id="outline-container-sec-16" class="outline-2  slide">
<h2 id="sec-16"><code>await</code>&#x2026;</h2>
<div class="outline-text-2" id="text-16">
<p>
<code>await</code> marks the start of a block that needs callbacks
</p>
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #859900; font-weight: bold;">await</span>
  some_long_running_function param_1, param_2, callback
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-17" class="outline-2  slide">
<h2 id="sec-17">&#x2026; <code>defer</code></h2>
<div class="outline-text-2" id="text-17">
<p>
<code>defer</code> takes some slots, and returns a callback function
</p>
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #859900; font-weight: bold;">await</span>
  some_long_running_function param1, param2, <span style="color: #859900; font-weight: bold;">defer</span>(slot1, slot2)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-18" class="outline-2  slide">
<h2 id="sec-18"><code>await</code> &#x2026; <code>defer</code></h2>
<div class="outline-text-2" id="text-18">
<p>
<code>await</code> waits for all <code>defer</code> s before proceeding, after which, the slots are filled
</p>
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">search</span> = (keyword, cb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">api</span> = <span style="color: #2aa198;">"https://www.googleapis.com/customsearch/v1"</span>
  <span style="color: #268bd2;">url</span> = <span style="color: #2aa198;">"</span><span style="color: #268bd2;">#{api}</span><span style="color: #2aa198;">?q=</span><span style="color: #268bd2;">#{keyword}</span><span style="color: #2aa198;">&amp;key=</span><span style="color: #268bd2;">#{key}</span><span style="color: #2aa198;">&amp;cx=</span><span style="color: #268bd2;">#{cx}</span><span style="color: #2aa198;">&amp;alt=json"</span>
  <span style="color: #859900; font-weight: bold;">await</span> request <span style="color: #b58900;">url:</span> url, <span style="color: #b58900;">json:</span> <span style="color: #268bd2; font-weight: bold;">true</span>, <span style="color: #859900; font-weight: bold;">defer</span> e, r, json
  cb json.items
</pre>
</div>

<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">search</span> = (keyword, cb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">api</span> = <span style="color: #2aa198;">"https://www.googleapis.com/customsearch/v1"</span>
  <span style="color: #268bd2;">url</span> = <span style="color: #2aa198;">"</span><span style="color: #268bd2;">#{api}</span><span style="color: #2aa198;">?q=</span><span style="color: #268bd2;">#{keyword}</span><span style="color: #2aa198;">&amp;key=</span><span style="color: #268bd2;">#{key}</span><span style="color: #2aa198;">&amp;cx=</span><span style="color: #268bd2;">#{cx}</span><span style="color: #2aa198;">&amp;alt=json"</span>
  request <span style="color: #b58900;">url:</span> url, <span style="color: #b58900;">json:</span> <span style="color: #268bd2; font-weight: bold;">true</span>, (e, r, json) <span style="color: #268bd2;">-&gt;</span>
    cb json.items
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-19" class="outline-2  slide">
<h2 id="sec-19">What&rsquo;s new?</h2>
<div class="outline-text-2" id="text-19">
</div><div id="outline-container-sec-19-1" class="outline-3">
<h3 id="sec-19-1"><code>await</code> &#x2026; <code>defer</code></h3>
</div>
<div id="outline-container-sec-19-2" class="outline-3">
<h3 id="sec-19-2"><code>autocb</code></h3>
</div>
</div>

<div id="outline-container-sec-20" class="outline-2  slide">
<h2 id="sec-20"><code>return cb()</code> is a common pattern</h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">search</span> = (keyword, cb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">api</span> = <span style="color: #2aa198;">"https://www.googleapis.com/customsearch/v1"</span>
  <span style="color: #268bd2;">url</span> = <span style="color: #2aa198;">"</span><span style="color: #268bd2;">#{api}</span><span style="color: #2aa198;">?q=</span><span style="color: #268bd2;">#{keyword}</span><span style="color: #2aa198;">&amp;key=</span><span style="color: #268bd2;">#{key}</span><span style="color: #2aa198;">&amp;cx=</span><span style="color: #268bd2;">#{cx}</span><span style="color: #2aa198;">&amp;alt=json"</span>
  <span style="color: #859900; font-weight: bold;">await</span> request <span style="color: #b58900;">url:</span> url, <span style="color: #b58900;">json:</span> <span style="color: #268bd2; font-weight: bold;">true</span>, <span style="color: #859900; font-weight: bold;">defer</span> e, r, json
  cb json.items
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-21" class="outline-2  slide">
<h2 id="sec-21">With <code>autocb</code></h2>
<div class="outline-text-2" id="text-21">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">search</span> = (keyword, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">api</span> = <span style="color: #2aa198;">"https://www.googleapis.com/customsearch/v1"</span>
  <span style="color: #268bd2;">url</span> = <span style="color: #2aa198;">"</span><span style="color: #268bd2;">#{api}</span><span style="color: #2aa198;">?q=</span><span style="color: #268bd2;">#{keyword}</span><span style="color: #2aa198;">&amp;key=</span><span style="color: #268bd2;">#{key}</span><span style="color: #2aa198;">&amp;cx=</span><span style="color: #268bd2;">#{cx}</span><span style="color: #2aa198;">&amp;alt=json"</span>
  <span style="color: #859900; font-weight: bold;">await</span> request <span style="color: #b58900;">url:</span> url, <span style="color: #b58900;">json:</span> <span style="color: #268bd2; font-weight: bold;">true</span>, <span style="color: #859900; font-weight: bold;">defer</span> e, r, json
  <span style="color: #859900; font-weight: bold;">return</span> json.items
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-22" class="outline-2  slide">
<h2 id="sec-22"><code>autocb</code> for multiple returns</h2>
<div class="outline-text-2" id="text-22">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">search</span> = (keyword, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #859900; font-weight: bold;">if</span> keyword?
    <span style="color: #268bd2;">api</span> = <span style="color: #2aa198;">"https://www.googleapis.com/customsearch/v1"</span>
    <span style="color: #268bd2;">url</span> = <span style="color: #2aa198;">"</span><span style="color: #268bd2;">#{api}</span><span style="color: #2aa198;">?q=</span><span style="color: #268bd2;">#{keyword}</span><span style="color: #2aa198;">&amp;key=</span><span style="color: #268bd2;">#{key}</span><span style="color: #2aa198;">&amp;cx=</span><span style="color: #268bd2;">#{cx}</span><span style="color: #2aa198;">&amp;alt=json"</span>
    <span style="color: #859900; font-weight: bold;">await</span> request <span style="color: #b58900;">url:</span> url, <span style="color: #b58900;">json:</span> <span style="color: #268bd2; font-weight: bold;">true</span>, <span style="color: #859900; font-weight: bold;">defer</span> e, r, json
    <span style="color: #859900; font-weight: bold;">return</span> json.items
  <span style="color: #859900; font-weight: bold;">else</span>
    <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span> <span style="color: #93a1a1;"># =&gt; cb ""</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-23" class="outline-2  slide">
<h2 id="sec-23">Flattening pyramids</h2>
<div class="outline-text-2" id="text-23">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #859900; font-weight: bold;">await</span> MongoClient.connect <span style="color: #2aa198;">'mongodb://127.0.0.1:27017/test'</span>, <span style="color: #859900; font-weight: bold;">defer</span> err, db
<span style="color: #859900; font-weight: bold;">if</span> err <span style="color: #859900; font-weight: bold;">throw</span> err
<span style="color: #859900; font-weight: bold;">await</span> db.dropDatabase <span style="color: #859900; font-weight: bold;">defer</span> err, done
<span style="color: #859900; font-weight: bold;">await</span> db.createCollection <span style="color: #2aa198;">'test_custom_key'</span>, <span style="color: #859900; font-weight: bold;">defer</span> err, collection
<span style="color: #859900; font-weight: bold;">await</span> collection.insert <span style="color: #2aa198;">'a'</span>:1, <span style="color: #859900; font-weight: bold;">defer</span> err, docs
<span style="color: #859900; font-weight: bold;">await</span> collection.find(<span style="color: #2aa198;">'_id'</span>:<span style="color: #859900; font-weight: bold;">new</span> ObjectID(<span style="color: #2aa198;">"aaaaaaaaaaaa"</span>)).toArray <span style="color: #859900; font-weight: bold;">defer</span> err, items
console.dir items
db.close()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-24" class="outline-2  slide">
<h2 id="sec-24"><code>if</code> &#x2026; <code>else</code></h2>
<div class="outline-text-2" id="text-24">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #859900; font-weight: bold;">await</span>
  <span style="color: #859900; font-weight: bold;">if</span> diskCache.has n
    diskCache.get n, <span style="color: #859900; font-weight: bold;">defer</span> value
  <span style="color: #859900; font-weight: bold;">else</span>
    networkClient.get n, <span style="color: #859900; font-weight: bold;">defer</span> value
doSomethingWith value
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-25" class="outline-2  slide">
<h2 id="sec-25"><code>for</code></h2>
<div class="outline-text-2" id="text-25">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">serialSearch</span> = (keywords, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #859900; font-weight: bold;">for</span> k,i <span style="color: #859900; font-weight: bold;">in</span> keywords
    <span style="color: #859900; font-weight: bold;">await</span> search k, <span style="color: #859900; font-weight: bold;">defer</span> out[i]
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-26" class="outline-2  slide">
<h2 id="sec-26"><code>for</code> in parallel</h2>
<div class="outline-text-2" id="text-26">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">parallelSearch</span> = (keywords, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #859900; font-weight: bold;">await</span> 
    <span style="color: #859900; font-weight: bold;">for</span> k,i <span style="color: #859900; font-weight: bold;">in</span> keywords
      search k, <span style="color: #859900; font-weight: bold;">defer</span> out[i]
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-27" class="outline-2  slide">
<h2 id="sec-27">If we didn&rsquo;t have ICS?</h2>
<div class="outline-text-2" id="text-27">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">parallelSearch</span> = (keywords, cb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">results</span> = []
  <span style="color: #268bd2;">n_out</span> = 0
  <span style="color: #268bd2;">cb_generator</span> = (i) <span style="color: #268bd2;">-&gt;</span>
    n_out++
    (json) <span style="color: #268bd2;">-&gt;</span>
      results[i] = json
      <span style="color: #859900; font-weight: bold;">if</span> n_out-- <span style="color: #859900; font-weight: bold;">is</span> 0
        cb results
  <span style="color: #859900; font-weight: bold;">for</span> k,i <span style="color: #859900; font-weight: bold;">in</span> keywords
    search k, cb_generator i
</pre>
</div>

<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">serialSearch</span> = (keywords, cb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">result</span> = []
  <span style="color: #268bd2;">i</span> = 0
  <span style="color: #268bd2;">launch</span> = () <span style="color: #268bd2;">-&gt;</span>
    <span style="color: #859900; font-weight: bold;">if</span> i &lt; keywords.length
       <span style="color: #268bd2;">j</span> = i++
       search keywords[j], cb_generator j
     <span style="color: #859900; font-weight: bold;">else</span>
       cb results
  <span style="color: #268bd2;">cb_generator</span> = (i) <span style="color: #268bd2;">-&gt;</span>
    (json) <span style="color: #268bd2;">-&gt;</span>
      results[i] = json
      launch()
  launch()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-28" class="outline-2  slide">
<h2 id="sec-28">We want it all!</h2>
<div class="outline-text-2" id="text-28">
<p>
Mix both serial and parallel: Limit simultaneous parallel operations?
</p>
</div>
</div>

<div id="outline-container-sec-29" class="outline-2  slide">
<h2 id="sec-29">Naïve way</h2>
<div class="outline-text-2" id="text-29">
<p>
Do in batches of <i>n</i>
</p>
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">windowedSearch</span> = (keywords, autocb, n=4) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #859900; font-weight: bold;">for</span> i <span style="color: #859900; font-weight: bold;">in</span> [0...keywords.length] <span style="color: #859900; font-weight: bold;">by</span> n
    <span style="color: #859900; font-weight: bold;">await</span> 
      <span style="color: #859900; font-weight: bold;">for</span> j <span style="color: #859900; font-weight: bold;">in</span> [i...i+n] <span style="color: #859900; font-weight: bold;">when</span> j &lt; keywords.length
        search keywords[j], <span style="color: #859900; font-weight: bold;">defer</span> out[j]
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>

<p>
How about keeping <i>n</i> requests in-flight at any time?
</p>
</div>
</div>

<div id="outline-container-sec-30" class="outline-2  slide">
<h2 id="sec-30">Using <code>Rendevous</code></h2>
<div class="outline-text-2" id="text-30">
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">rendevousSearch</span> = (keywords, autocb, n=4) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #268bd2;">rv</span> = <span style="color: #859900; font-weight: bold;">new</span> iced.Rendezvous
  <span style="color: #268bd2;">nsent</span> = 0
  <span style="color: #268bd2;">nrecv</span> = 0

  <span style="color: #859900; font-weight: bold;">while</span> nrecv &lt; keywords.length
    <span style="color: #859900; font-weight: bold;">if</span> nsent - nrecv &lt; n <span style="color: #859900; font-weight: bold;">and</span>  nsent &lt; n
      search keywords[nsent], rv.<span style="color: #859900; font-weight: bold;">defer</span> out[nsent]
      nsent++
    <span style="color: #859900; font-weight: bold;">else</span>
      <span style="color: #859900; font-weight: bold;">await</span> rv.wait <span style="color: #859900; font-weight: bold;">defer</span>()
      nrecv++
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-31" class="outline-2  slide">
<h2 id="sec-31">Using <code>Pipeliner</code></h2>
<div class="outline-text-2" id="text-31">
<div class="org-src-container">

<pre class="src src-coffee">{Pipeliner} = require <span style="color: #2aa198;">'icedlib'</span>

<span style="color: #268bd2;">pipelinerSearch</span> = (keywords, autocb, n=4) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #268bd2;">pipeliner</span> = <span style="color: #859900; font-weight: bold;">new</span> Pipeliner n

  <span style="color: #859900; font-weight: bold;">for</span> k, i <span style="color: #859900; font-weight: bold;">in</span> keywords
    <span style="color: #859900; font-weight: bold;">await</span> pipeliner.waitInQueue <span style="color: #859900; font-weight: bold;">defer</span>()
    search k, pipeliner.<span style="color: #859900; font-weight: bold;">defer</span> out[i]

  <span style="color: #859900; font-weight: bold;">await</span> pipeliner.flush <span style="color: #859900; font-weight: bold;">defer</span>()
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-32" class="outline-2  slide">
<h2 id="sec-32">Try many, but use the first hit</h2>
<div class="outline-text-2" id="text-32">
<p>
E.g. post a single request to multiple servers and use the fastest
result
</p>

<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">firstSearch</span> = (engines, keyword, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #268bd2;">rv</span> = <span style="color: #859900; font-weight: bold;">new</span> iced.Rendezvous

  <span style="color: #859900; font-weight: bold;">for</span> e, i <span style="color: #859900; font-weight: bold;">in</span> engines
    searchWith e, keyword, rv.<span style="color: #859900; font-weight: bold;">defer</span> out[i]
  <span style="color: #859900; font-weight: bold;">await</span> rv.wait <span style="color: #859900; font-weight: bold;">defer</span> which
  <span style="color: #859900; font-weight: bold;">return</span> out[which]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-33" class="outline-2  slide">
<h2 id="sec-33">Time out</h2>
<div class="outline-text-2" id="text-33">
<p>
What if a request takes too long?
</p>
<div class="org-src-container">

<pre class="src src-coffee"><span style="color: #268bd2;">parallelSearch</span> = (keywords, autocb) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #859900; font-weight: bold;">await</span> 
    <span style="color: #859900; font-weight: bold;">for</span> k,i <span style="color: #859900; font-weight: bold;">in</span> keywords
      search k, <span style="color: #859900; font-weight: bold;">defer</span> out[i]
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-34" class="outline-2  slide">
<h2 id="sec-34"><code>timeout</code> to the rescue</h2>
<div class="outline-text-2" id="text-34">
<div class="org-src-container">

<pre class="src src-coffee">{timeout} = require <span style="color: #2aa198;">'icedlib'</span>

<span style="color: #268bd2;">parallelSearch</span> = (keywords, autocb, maxTime=500) <span style="color: #268bd2;">-&gt;</span>
  <span style="color: #268bd2;">out</span> = []
  <span style="color: #859900; font-weight: bold;">await</span> 
    <span style="color: #859900; font-weight: bold;">for</span> k,i <span style="color: #859900; font-weight: bold;">in</span> keywords
      search k, timeout <span style="color: #859900; font-weight: bold;">defer</span>(out[i]), maxTime
  <span style="color: #859900; font-weight: bold;">return</span> out
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-35" class="outline-2  slide">
<h2 id="sec-35">It&rsquo;s easy</h2>
<div class="outline-text-2" id="text-35">
<p>
Asynchronous callbacks with Iced CoffeeScript are easy
</p>


<div class="figure">
<p><img src="./images/icedcoffee.jpg"  alt="icedcoffee.jpg"/></p>
</div>

<p>
Who would&rsquo;ve thunk?
</p>
</div>
</div>

<div id="outline-container-sec-36" class="outline-2  slide">
<h2 id="sec-36">Download &amp; contact</h2>
<div class="outline-text-2" id="text-36">
<p>
<a href="http://thirteen37.github.io/ics-intro">http://thirteen37.github.io/ics-intro</a>
</p>

<ul class="org-ul">
<li>limyuxi@gmail.com
</li>
<li>@snarfnbarf
</li>
</ul>
</div>
</div>


<!-- Place the following snippet at the bottom of the deck container. -->
<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>
<!-- Place the following snippet at the bottom of the deck container. -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>
<!-- Place the following snippet at the bottom of the deck container. -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>
<!-- Place the following snippet at the bottom of the deck container. -->
<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
	<datalist id="goto-datalist"></datalist>
	<input type="submit" value="Go">
</form>

</div>
</body>
</html>
